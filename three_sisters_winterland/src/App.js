import { useEffect, useMemo, useState } from 'react';
import './App.css';
import heroImage from './assets/northern-path-hero.gif';
import aidaiImage from './assets/aidai.png';
import elinaImage from './assets/elina.png';
import meetImage from './assets/meet.png';

const scenes = {
  home: {
    id: 'home',
    title: 'Северный путь',
    text: 'История двух сестёр в суровом северном мире.',
    hero: true,
    options: [{ id: 'start', label: 'Играть', next: 'intro' }],
  },
  intro: {
    id: 'intro',
    title: 'Выбор сестры',
    text:
      'Выберите, за кого начать историю. Второй игрок идёт по тем же сценам, но его выборы становятся серыми.',
    options: [
      { id: 'aidai', label: 'Играть за Айдай' },
      { id: 'elina', label: 'Играть за Элину' },
    ],
  },

  P1: {
    id: 'P1',
    title: 'Сцена 0.1 — Письма',
    text: `Письма из Северного королевства всегда приходили не вдруг, а как часть сезона, как часть пути, которому положено существовать, пока мир держит своё обещание оставаться связным.

Сначала они были простыми и светлыми, полными имен, бытовых мелочей и маленьких радостей, которые не принято считать важными, пока они не исчезают, а затем стали более редкими, словно слова в них начали экономить, оставляя в строках больше воздуха, чем раньше.

Подруга твоя писала аккуратно, так, как пишут те, кто привык отвечать не только сердцем, но и обязанностью, и даже сквозь вежливые обороты ты могла различить усталость, которую она старалась не показывать.

Ты не называла её имя вслух без необходимости, как не называют вслух некоторые тропы, если не хотят, чтобы их заметили, однако в мыслях имя звучало ясно, потому что в памяти оно не причиняло ей вреда.

Она вышла замуж за принца Северного королевства несколько месяцев назад, и первые недели после свадьбы в её письмах было больше света, чем ты ожидала, будто ей удалось нащупать в чужом дворце маленькое место, где можно дышать.

Потом свет стал осторожнее.

Потом — тише.

А потом письма перестали приходить.

Ты не подумала сразу о худшем, потому что эльфы редко позволяют себе растратить разум на бездоказательные страхи, однако ты заметила перемену так же ясно, как заметила бы неверный след на свежем снегу.`,
    options: [{ id: 'P1-1', label: 'Далее', next: 'P2' }],
  },
  P2: {
    id: 'P2',
    title: 'Сцена 0.2 — Тишина с Севера',
    text: `Зима в тот год пришла как обычно, без злобы и без милости, и всё же в её привычности было что-то успокаивающее, потому что привычное даёт точку отсчёта.

Ты продолжала жить так, как требует порядок следопытов, следя за дозорами, разбирая отчёты, направляя тех, кто уходил на тропы, и возвращая их обратно, но в свободные минуты ты ловила себя на том, что смотришь на север дольше, чем необходимо.

Не потому, что там непременно таилась беда, а потому, что отсутствие вестей само по себе было вестью, которую ещё нужно было научиться читать.

На людских дорогах говорили о холоде, о ценах на соль, о том, что торговцы стали осторожнее, и в этих разговорах не было ненависти к эльфам, а было лишь обычное человеческое желание понять, что происходит за дальними перевалами.

Ты слушала спокойно, потому что людям свойственно бояться неизвестного, но тебе было важно различать, где заканчивается страх и начинается факт.`,
    options: [{ id: 'P2-1', label: 'Далее', next: 'P3' }],
  },
  P3: {
    id: 'P3',
    title: 'Сцена 0.3 — Слухи',
    text: `Слухи не приходят прямо, потому что прямота редко выживает в местах, где власть становится нервной.

Они цепляются за края разговоров, за паузы, за излишне вежливые улыбки, и ты начала замечать их в Лаупхейме, у костров, на постоялых дворах, где путники согревают руки не только у огня, но и у чужих историй.

Говорили, что на Севере стало больше стражи, что караваны идут иным порядком, что в окнах некоторых домов гаснет свет раньше обычного, словно люди учатся не привлекать внимания.

И всё же никто не говорил о войне громко, потому что у людей и у эльфов есть общая осторожность: если назвать бурю раньше времени, она может решить, что её зовут.`,
    options: [{ id: 'P3-1', label: 'Далее', next: 'P4' }],
  },
  P4: {
    id: 'P4',
    title: 'Сцена 0.4 — Доклад дозорного',
    text: `Когда времени не хватает, послания не отправляют — их приносят лично, потому что личное присутствие тоже часть точности, и иногда именно оно удерживает смысл от искажений.

Дозорный следопыт прибыл к вечеру, в тот час, когда свет становится мягким и не принадлежит ни дню, ни ночи полностью, и мир словно замирает, прислушиваясь к самому себе. Ты заметила его ещё до того, как он появился из сумерек, потому что тишина вокруг него изменилась — и эта перемена была знаком, понятным тем, кто всю жизнь учился читать тропы.

Он не вошёл сразу, сперва взглядом отметил двор, окна и выход, не из подозрительности, а из привычной внимательности, которая у следопытов считается формой заботы о других. Лишь после этого он подошёл ближе, снял капюшон ровно настолько, чтобы открыть лицо, и опустился на одно колено спокойно, без театра.

— Главнокомандующая следопытов, — произнёс он. — Дозорный сектора Лаупхейм — восточные тракты. Прибыл с донесением по уставу.

Ты позволила паузе занять своё место.

— Встаньте и говорите.

Ты заметила мелочи прежде, чем он начал: иней на ресницах, тонкую полосу соли на плаще, сухие перчатки. Всё это говорило о том, что он шёл быстро, редко задерживаясь у огня и не позволяя дороге говорить за него.

— На восточной границе происходят перемены, — сказал он. — Не резкие, но согласованные.

Он говорил не как тот, кто приносит тревогу, а как тот, кто приносит карту.

Караваны стали менять маршруты без видимых причин. Мосты, которые обычно не трогают зимой, внезапно начали чинить. В нескольких местах появились новые дозоры, и они задавали вопросы не о товарах, а о людях: откуда, куда, по чьему поручению.

— Это не похоже на обычную осторожность, — продолжил он. — И не похоже на беспорядок. Это похоже на перестройку.

Он развернул карту — простую, рабочую, без украшений, — и отметил несколько точек.

Развилка, где раньше путники останавливались свободно, а теперь должны объяснять, зачем идут.

Постоялый двор, где хозяину велели вести двойные списки.

Переправа, на которой стража стала меняться каждые два дня, будто кто-то не хотел, чтобы одни и те же лица запоминали слишком много.

— Люди не злы, — добавил он. — Они не понимают, что происходит, и потому стараются не задавать лишних вопросов.

Ты спросила о знаках.

Он ответил, что на форме всё чаще появляются новые символы — похожие на прежние, но не совпадающие с ними полностью, словно их сделали так, чтобы издалека они казались знакомыми.

— Это не маскировка, — сказал он. — Это привыкание.

Ты слушала, не перебивая.

— Имена в разговорах стали реже, — продолжил он. — Особенно имена тех, кто обычно задаёт тон.

Ты задала последний вопрос.

— Есть ли вести о женщине при дворе, чьи письма перестали доходить?

Он не отвёл взгляда.

— О ней не говорят, — ответил он. — Не из ненависти. Из осторожности.

Он сказал, что слышал это молчание в разных местах, и оно было одинаковым.

— Её судьба неизвестна.

Ты сложила пергамент.

— Благодарю, — сказала ты. — Вы исполнили свой путь.

Он склонил голову.

— Эти изменения коснутся не только людей, — добавил он. — Тропы меняются раньше границ.

Ты кивнула.`,
    options: [{ id: 'P4-1', label: 'Далее', next: 'P5' }],
  },
  P5: {
    id: 'P5',
    title: 'Сцена 0.5 — Донесение в Леса Вечной Песни',
    text: `Ты не стала ждать, пока услышанное превратится в слух.

В тот же вечер ты велела подготовить донесение для верховного лорда эльфов, чьё слово звучит в Лесах Вечной Песни, как звучат старые имена рек — не громко, но так, что их помнят.

Ты писала кратко.

Не потому, что не чувствовала, а потому, что форма — тоже часть долга.

> *Северное королевство меняет порядок на восточной границе.*
> *Движения согласованы, но не объявлены.*
> *Меняются маршруты, дозоры, знаки, способы учёта.*
> *Люди растеряны, но не враждебны.*
> *Имена звучат реже, чем раньше.*
> *Тропы становятся плотнее.*
>
> *Судьба женщины при дворе, с которой у нас была связь, неизвестна.*
> *Её имя избегают.*
> *Молчание повторяется слишком ровно, чтобы быть случайным.*
>
> *Прошу позволения продолжить наблюдение и отправиться к источнику этих перемен.*
> *Не для вмешательства, а для понимания.*

Ты поставила знак ордена следопытов — не печать, а начертание, которое нельзя подделать, потому что оно читается не глазами, а вниманием.

Гонец ушёл в Леса Вечной Песни ещё до того, как ночь успела полностью занять небо.

Ты знала: теперь твой путь имеет не только личный, но и служебный смысл.

Ты не позволила разговору превратиться в гадание, потому что гадания хороши для песен, но редко помогают, когда требуется решение.

Ты вернулась к письмам, которые у тебя сохранились, и перечитала их не ради тоски, а ради структуры, пытаясь увидеть в них не эмоцию, а траекторию.

Поначалу подруга писала о людях при дворе с осторожной добротой, отмечая, кто помог ей привыкнуть к новым обычаям, кто неловко, но искренне пытался быть внимательным, и как много там зависит от слов, произнесённых вовремя.

Потом в её письмах стало больше правил и меньше дыхания, как будто кто-то незаметно научил её говорить только то, что безопасно.

И всё же даже в самых правильных строках ты находила маленькие отклонения, знакомые тебе, потому что они были её, и именно поэтому отсутствие следующих писем ощущалось не как трагедия, а как разрыв линии, которую кто-то оборвал слишком ровно.`,
    options: [{ id: 'P5-1', label: 'Далее', next: 'P6' }],
  },
  P6: {
    id: 'P6',
    title: 'Сцена 0.6 — Решение',
    text: `Решение сложилось постепенно, как узор, который становится заметен лишь тогда, когда нити уже переплелись достаточно плотно.

Север готовился к войне на востоке, а это означало, что столица Северного королевства станет местом, где сходятся причины и последствия, приказы и слухи, человеческая суета и настоящие маршруты власти.

Если вестей о твоей подруге не было, значит, узнавать нужно было не у случайных путников, а там, где письма исчезают прежде всего — в центре, где решают, что должно быть сказано и что должно быть забыто.

Ты позвала писца, затем дозорного, затем хранительницу троп, и каждый из них получил задачу не из паники, а из порядка.

Ты продиктовала послание Айдай, делая его таким, каким должно быть послание между эльфами: вежливым, ясным и без лишнего давления.

> «С Севера нет вестей, а молчание стало слишком ровным, чтобы быть случайностью.
> Дозор подтверждает перегруппировки и подготовку к войне с восточными землями.
> Я намерена идти в столицу Северного королевства и понять, что скрывается под их тишиной.
> Прошу вас прибыть, чтобы мы шли вместе и говорили одним голосом».

Гонец отправился в приют Скитальца, где пути пересекаются и где всегда найдётся огонь и слово для тех, кто идёт не в бегство, а по делу.

Затем ты подготовила второй свёрток, более официальный и более тяжёлый по смыслу, и предназначила его не людям.

Это было донесение верховному лорду-вождю эльфов, потому что если северная зима меняет порядок на границах, то это касается не только людей и не только их королевства.

Ты сформулировала всё так, как требуют старые традиции: без обвинений, без угроз, но с ясным указанием на движение сил и на необходимость наблюдения.`,
    options: [{ id: 'P6-1', label: 'Далее', next: 'P7' }],
  },
  P7: {
    id: 'P7',
    title: 'Сцена 0.7 — Разговор с Айдай',
    text: `Айдай прибыла в тот же вечер, когда гонец успел передать письмо, потому что у неё всегда было своё понимание времени, в котором важное не откладывают, даже если оно не кричит.

Ты вышла ей навстречу, и ваше приветствие было коротким и тёплым, как бывает у сестёр, которые долго ходили разными тропами, но не разучились узнавать друг друга по шагам.

Вы сели у огня, и сначала разговор шёл о простом, потому что простое тоже держит мир, когда в нём появляется слишком много неизвестного.

Потом ты изложила всё по порядку: прекращение писем, характер слухов, доклад дозорного, направление северных приготовлений.

Айдай слушала внимательно, и хотя её натура была более прямая, чем твоя, в такие моменты она умела не перебивать, словно понимала, что тишина тоже является частью разведки.

— Ты хочешь идти в их столицу, — сказала она наконец, и это прозвучало не как упрёк и не как страх, а как фиксация маршрута.

— Я хочу узнать, что стало причиной их тишины, — ответила ты. — И если мы сможем понять это раньше других, мы сумеем помочь и людям, и нашим.

Айдай кивнула, и в её кивке было простое, надёжное согласие.

— Тогда мы идём вместе, — сказала она, как говорят о дороге, которая выбрана.`,
    options: [{ id: 'P7-1', label: 'Далее', next: 'P8' }],
  },
  P8: {
    id: 'P8',
    title: 'Сцена 0.8 — Начало',
    text: `С этого момента пролог перестаёт быть набором знаков и становится подготовкой к пути, который ещё не обещает ответа, но уже обещает движение, а это для следопытов часто важнее любого утешения.

Вы собираете вещи не поспешно, но тщательно, как собирают не для бегства, а для дороги, где нужно уметь и слушать, и говорить, и быть вежливыми даже тогда, когда мир вокруг становится более строгим.

Зима не становится врагом, потому что она всегда была частью мира, и вы привыкли уважать её, однако вы чувствуете, что на дальних дорогах меняется не погода, а порядок людей.

И хотя судьба твоей подруги остаётся неизвестной, это неизвестное звучит не как угроза, а как вопрос, на который стоит найти ответ, прежде чем его начнут придумывать другие.`,
    options: [
      {
        id: 'P8-1',
        label: 'Далее',
        next: 'S10',
        setFlags: [
          'prologue_started',
          'alarm_raised_by_player2',
          'sisters_united',
          'north_silence_noted',
          'war_preparations_reported',
          'report_sent_to_elven_high_lord',
        ],
      },
    ],
  },
  S10: {
    id: 'S10',
    title: 'Сцена 1.0 — Встреча',
    text: `Снег в этот день ложился ровно и спокойно, будто старался не привлекать к себе лишнего внимания, а просто делать улицу чуть тише, чуть светлее и чуть мягче. Воздух был прозрачным, холодным, но не резким — таким, каким он бывает в начале зимы, когда она ещё не решила, будет ли суровой или милостивой.

Ты заметила Айдай издалека.

Она шла уверенно, чуть быстрее, чем окружающие, словно у неё уже была цель, даже если она ещё не была названа вслух. Белый плащ выделял её на фоне города — не вызывающе, но заметно, как свежий след на нетронутом снегу.

Ты остановилась.

Не потому, что нужно было остановиться.

А потому, что тебе захотелось посмотреть.

Айдай подняла взгляд.

Ваши глаза встретились.

Ты улыбнулась.

Не широко. Не открыто.

Слишком ехидно, чтобы это можно было не заметить.

Айдай сразу насторожилась.

Она подошла ближе и остановилась прямо перед тобой.

— Что? — спросила она.

Ты пожала плечами.

— Ничего.

Айдай прищурилась.

— В смысле «ничего»?

Ты попыталась сохранить серьёзное лицо.

Не вышло.

Уголки губ дрогнули.

— Элина, — сказала Айдай строго.

Ты посмотрела на неё.

И не выдержала.

Смех вырвался тихо, почти виновато.

— Ну ладно, — сказала ты. — Скажи честно… кто жених?

Айдай моргнула.

— Что?

Ты кивнула на её плащ.

— Я просто спрашиваю. Вдруг я что-то пропустила.

Айдай уставилась на тебя.

— Да иди ты.

— Ну а чего вы так в белое нарядились? — продолжила ты с самым невинным видом.

Айдай скрестила руки.

— Зима.

Ты задумалась.

Кивнула.

— Ну… тоже верно, сестра.

Она фыркнула.

— Ты неисправима.

— Ты меня любишь, — заметила ты.

Айдай вздохнула, но уголки её губ всё-таки дрогнули.

— Пойдём уже, — сказала она. — Пока ты не придумала ещё что-нибудь.

Ты шагнула рядом с ней.

И вы пошли вместе.

Не торопясь.

Как идут те, кто уже согласился, даже если ещё не обсуждал вслух.`,
    options: [{ id: 'S10-1', label: 'Далее', next: 'T0' }],
  },
  T0: {
    id: 'T0',
    title: 'Трактир «Северный огонь» — Вход',
    text:
      'Дверь закрывается за вами тяжёлым звуком. Внутри теплее, но не тепло. Огонь в очаге трещит, будто сердится. Запах эля, мокрых плащей и дыма. Люди говорят тихо — не потому что устали, а потому что не хотят, чтобы их слышали.',
    options: [
      { id: 'T0-1', label: 'Осмотреть зал', next: 'T1' },
      { id: 'T0-2', label: 'Подойти к стойке', next: 'T2' },
      { id: 'T0-3', label: 'Сесть за ближайший стол', next: 'T7' },
      { id: 'T0-4', label: 'Остаться у двери', next: 'T6' },
    ],
  },
  T1: {
    id: 'T1',
    title: 'Осмотр зала',
    text:
      'Зал полон. Люди смеются, поют, играют в кости. Огонь отражается в кружках. Смех — как занавес. Ты замечаешь мужчину у стены, стражника у окна, ремесленника и стол в углу.',
    options: [
      { id: 'T1-1', label: 'Подойти к ремесленнику', next: 'T3', setFlags: ['talked_to_blacksmith'] },
      { id: 'T1-2', label: 'Подойти к стражнику', next: 'T4', setFlags: ['talked_to_guard'] },
      { id: 'T1-3', label: 'Подойти к трактирщику', next: 'T2', setFlags: ['talked_to_barkeep'] },
      { id: 'T1-4', label: 'Подойти к тем, кто в углу', next: 'T5', setFlags: ['talked_to_bandits'] },
      { id: 'T1-5', label: 'Вернуться ко входу', next: 'T0' },
    ],
  },
  T2: {
    id: 'T2',
    title: 'Трактирщик',
    text:
      'Трактирщик улыбается привычно. Он вытирает уже чистую кружку. Когда ты подходишь, он смотрит не на тебя, а в сторону. И сразу обратно.',
    options: [
      { id: 'T2-1', label: 'Заказать эль', next: 'T7', setFlags: ['ordered_drink'] },
      { id: 'T2-2', label: 'Спросить, что происходит в городе', next: 'T7', setFlags: ['talked_to_barkeep'] },
      { id: 'T2-3', label: 'Спросить про дороги', next: 'T7', setFlags: ['asked_about_roads'] },
      { id: 'T2-4', label: 'Оставить больше монет, чем нужно', next: 'S0', setFlags: ['overpaid_barkeep', 'path2_active'] },
      { id: 'T2-5', label: 'Вернуться в зал', next: 'T1' },
    ],
  },
  T3: {
    id: 'T3',
    title: 'Ремесленник',
    text:
      'Он говорит о торговцах, политике, страхе. «Вы не понимаете. Они перестали продавать. Это не зима. Это подготовка».',
    options: [
      { id: 'T3-1', label: 'Спросить, что он имеет в виду', next: 'T1' },
      { id: 'T3-2', label: 'Спросить про север', next: 'T1' },
      { id: 'T3-3', label: 'Спросить про торговцев', next: 'T1' },
      { id: 'T3-4', label: 'Спросить про зверей', next: 'T1' },
    ],
  },
  T4: {
    id: 'T4',
    title: 'Стражник',
    text:
      'Он смотрит в окно. Говорит о лошадях, вернувшихся без людей. О странных следах.',
    options: [
      { id: 'T4-1', label: 'Спросить про лошадей', next: 'T1' },
      { id: 'T4-2', label: 'Спросить про обозы', next: 'T1' },
      { id: 'T4-3', label: 'Спросить, что он видел', next: 'T1' },
      { id: 'T4-4', label: 'Предложить монеты', next: 'S0' },
    ],
  },
  T5: {
    id: 'T5',
    title: 'Разбойники',
    text: 'Они говорят о путях, которые «не для всех».',
    options: [
      { id: 'T5-1', label: 'Спросить, что он имеет в виду', next: 'S0', setFlags: ['path4_active'] },
      { id: 'T5-2', label: 'Спросить про дороги', next: 'S0', setFlags: ['path4_active'] },
      { id: 'T5-3', label: 'Спросить, могут ли помочь', next: 'S0', setFlags: ['path4_active'] },
      { id: 'T5-4', label: 'Уйти', next: 'T1' },
    ],
  },
  T6: {
    id: 'T6',
    title: 'Трус',
    text:
      'Скрип стула. Взгляд, который скользит мимо. Кто-то уходит слишком быстро, будто боится быть замеченным.',
    options: [{ id: 'T6-1', label: 'Вернуться к залу', next: 'T1', setFlags: ['coward_seen'] }],
  },
  T7: {
    id: 'T7',
    title: 'Центр зала',
    text: 'Музыка громче, смех резче. В этом шуме трудно понять, кто слушает.',
    options: [
      { id: 'T7-1', label: 'Ремесленник', next: 'T3' },
      { id: 'T7-2', label: 'Трактирщик', next: 'T2' },
      { id: 'T7-3', label: 'Стражник', next: 'T4' },
      { id: 'T7-4', label: 'Угол', next: 'T5' },
      { id: 'T7-5', label: 'Выйти', next: 'T8' },
    ],
  },
  T8: {
    id: 'T8',
    title: 'Выход',
    text: 'Свет внутри, снег снаружи. Ветер пахнет хвоей и недосказанностью.',
    options: [
      { id: 'T8-1', label: 'Пойти к повозке', next: 'S0' },
      { id: 'T8-2', label: 'Пойти по улице', next: 'S1' },
      { id: 'T8-3', label: 'Остановиться', next: 'T0' },
    ],
  },
  S0: {
    id: 'S0',
    title: 'Улица',
    text:
      'Снег скрипит под сапогами. Холодный воздух мгновенно забирается под плащ.',
    options: [{ id: 'S0-1', label: 'Пойти к повозке', next: 'C0', setFlags: ['cart_seen'] }],
  },
  S1: {
    id: 'S1',
    title: 'Переход',
    text: 'Дорога тянется вдоль домов, но взгляд всё равно возвращается к повозке.',
    options: [{ id: 'S1-1', label: 'К повозке', next: 'C0', setFlags: ['cart_seen'] }],
  },
  C0: {
    id: 'C0',
    title: 'Повозка',
    text: 'Лошади беспокойны. На снегу видны следы, которые ведут в разные стороны.',
    options: [{ id: 'C0-1', label: 'Осмотреться ближе', next: 'C1' }],
  },
  C1: {
    id: 'C1',
    title: 'Осмотр',
    text:
      'Под досками ты находишь стрелы. Боевые наконечники чистые, почти новые.',
    options: [{ id: 'C1-1', label: 'Подумать, что это значит', next: 'C2', setFlags: ['arrowheads_found'] }],
  },
  C2: {
    id: 'C2',
    title: 'Выбор',
    text:
      'Слишком много путей. Каждый обещает ответ, но каждый требует цены.',
    options: [
      { id: 'C2-1', label: 'Вернуться в трактир', next: 'T3', setFlags: ['path1_active'] },
      { id: 'C2-2', label: 'Пойти к Анне', next: 'A0', setFlags: ['path2_active'] },
      { id: 'C2-3', label: 'Осмотреться и подумать', next: 'E0', setFlags: ['path6_active', 'noticed_dry_wood'] },
      { id: 'C2-4', label: 'Пойти по следам', next: 'E0', setFlags: ['path4_active', 'followed_tracks'] },
      { id: 'C2-5', label: 'Уйти, не решая', next: 'E0', setFlags: ['path3_active'] },
    ],
  },
  A0: {
    id: 'A0',
    title: 'Дом Анны',
    text:
      'Анна — вдова торговца. Она смотрит на тебя долго, прежде чем сказать: «Можно идти через поселения. Это дольше, но безопаснее».',
    options: [{ id: 'A0-1', label: 'Согласиться', next: 'E0' }],
  },
  E0: {
    id: 'E0',
    title: 'Выход к лесу',
    text:
      'Город остаётся позади. Лес принимает вас без вопросов. Теперь путь выбран, и он будет помнить каждый шаг.',
    options: [{ id: 'E0-1', label: 'Продолжить путь', next: 'intro', setFlags: ['game_started'] }],
  },
};

const starterFlags = {
  game_started: false,
  player1: false,
  player2: false,
  prologue_started: false,
  alarm_raised_by_player2: false,
  sisters_united: false,
  north_silence_noted: false,
  war_preparations_reported: false,
  report_sent_to_elven_high_lord: false,
};

function App() {
  const [currentId, setCurrentId] = useState('home');
  const [flags, setFlags] = useState(starterFlags);
  const [history, setHistory] = useState([]);
  const [isFirstLoad, setIsFirstLoad] = useState(true);

  const currentScene = scenes[currentId];

  const playerLabel = useMemo(() => {
    if (flags.player1) return 'Айдай';
    if (flags.player2) return 'Элина';
    return 'Гость';
  }, [flags]);

  const isPlayerTwo = flags.player2;
  const selectedHero = useMemo(() => {
    if (flags.player1) {
      return { id: 'aidai', label: 'Айдай', image: aidaiImage };
    }
    if (flags.player2) {
      return { id: 'elina', label: 'Элина', image: elinaImage };
    }
    return null;
  }, [flags.player1, flags.player2]);

  const handleOption = (option) => {
    if (!option) return;
    if (currentId === 'intro' && (option.id === 'aidai' || option.id === 'elina')) {
      setFlags((prev) => ({
        ...prev,
        player1: option.id === 'aidai',
        player2: option.id === 'elina',
      }));
      return;
    }
    const next = option.next ?? currentId;
    setHistory((prev) => [...prev, currentId]);
    setCurrentId(next);
    if (option.setFlags?.length) {
      setFlags((prev) => {
        const updated = { ...prev };
        option.setFlags.forEach((flag) => {
          updated[flag] = true;
        });
        return updated;
      });
    }
  };

  const canInteract = !isPlayerTwo;

  useEffect(() => {
    setIsFirstLoad(false);
  }, []);

  const fadeClass = isFirstLoad ? 'App-fade App-fade--slow' : 'App-fade';

  return (
    <div className="App">
      {currentScene.hero ? (
        <main className={`App-home ${fadeClass}`} key={currentId}>
          <div className="App-home-title">
            <p className="App-overline">Сюжетная игра</p>
            <h1 className="App-title">{currentScene.title}</h1>
            <p className="App-home-text">{currentScene.text}</p>
          </div>
          <div className="App-hero-card">
            <img className="App-hero-image" src={heroImage} alt="Северный путь — героиня на северном ветру" />
          </div>
          <button
            className="App-button App-button--primary App-home-button"
            type="button"
            onClick={() => handleOption(currentScene.options[0])}
          >
            {currentScene.options[0].label}
          </button>
        </main>
      ) : (
        <>
          <header className="App-header">
            <div>
              <p className="App-overline">Северный путь</p>
              <h1 className="App-title">{currentScene.title}</h1>
            </div>
            <div className="App-meta">
              <span>{playerLabel}</span>
              <span>Сцена: {currentScene.id}</span>
            </div>
          </header>
          <main className={`App-content ${fadeClass}`} key={currentId}>
            {currentId === 'S10' && (
              <div className="App-hero-card">
                <img className="App-hero-image" src={meetImage} alt="Встреча" />
              </div>
            )}
            <div className="App-text">
              <p className="App-text-content">{currentScene.text}</p>
            </div>
            <div className="App-options">
              {currentScene.options.map((option) => {
                const disabled = !canInteract && currentId !== 'intro';
                return (
                  <button
                    className="App-button"
                    type="button"
                    key={option.id}
                    onClick={() => handleOption(option)}
                    disabled={disabled}
                  >
                    {option.label}
                  </button>
                );
              })}
              {!canInteract && currentId !== 'intro' && (
                <button
                  className="App-button App-button--primary"
                  type="button"
                  onClick={() => handleOption(currentScene.options[0])}
                >
                  Далее
                </button>
              )}
            </div>
            {currentId === 'intro' && selectedHero && (
              <div className="App-hero-choice App-fade" key={selectedHero.id}>
                <img
                  className="App-hero-choice-image"
                  src={selectedHero.image}
                  alt={`Героиня ${selectedHero.label}`}
                />
                <button
                  className="App-button App-button--primary App-hero-choice-button"
                  type="button"
                  onClick={() => handleOption({ id: 'start', next: 'P1' })}
                >
                  Играть
                </button>
              </div>
            )}
          </main>
          <footer className="App-footer">
            <button
              className="App-link"
              type="button"
              onClick={() => setCurrentId(history[history.length - 1] || 'home')}
              disabled={history.length === 0}
            >
              Назад
            </button>
            <button
              className="App-link"
              type="button"
              onClick={() => {
                setCurrentId('home');
                setFlags(starterFlags);
                setHistory([]);
              }}
            >
              Начать заново
            </button>
          </footer>
        </>
      )}
    </div>
  );
}

export default App;
